<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>俄羅斯方塊 - 增強版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
            overflow-y: hidden; /* 防止上下滾動 */
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 2.8rem;
            background: linear-gradient(90deg, #ff0080, #00ccff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 204, 255, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #aaa;
            margin-bottom: 25px;
        }
        
        .game-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            max-width: 1200px;
            width: 100%;
        }
        
        .left-panel, .right-panel {
            background-color: rgba(20, 20, 30, 0.8);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.5s ease;
        }
        
        .left-panel {
            width: 320px;
            display: flex;
            flex-direction: column;
        }
        
        .right-panel {
            width: 320px;
        }
        
        .game-board {
            position: relative;
        }
        
        canvas {
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 100, 255, 0.2);
            background-color: #000;
            transition: all 0.3s ease;
            /* 防止畫布上的觸摸滾動 */
            touch-action: manipulation;
        }
        
        .game-info {
            margin-bottom: 25px;
        }
        
        .info-title {
            font-size: 1.4rem;
            color: #00ccff;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .info-box {
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #ff0080;
            transition: all 0.3s ease;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .info-value {
            color: #ffcc00;
            font-weight: bold;
        }
        
        .high-score {
            color: #ff0080;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .score-animation {
            animation: scorePop 0.5s ease;
        }
        
        @keyframes scorePop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .controls {
            margin-top: auto;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 6px;
        }
        
        .key {
            display: inline-block;
            background-color: #222;
            color: #ffcc00;
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            margin-right: 15px;
            min-width: 60px;
            text-align: center;
            border: 1px solid #444;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        button {
            flex: 1;
            padding: 14px 0;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(to right, #ff0080, #00ccff);
            color: white;
            letter-spacing: 1px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 204, 255, 0.4);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        #pause-btn {
            background: linear-gradient(to right, #ff9900, #ffcc00);
        }
        
        #reset-btn {
            background: linear-gradient(to right, #9900ff, #cc00ff);
        }
        
        .next-piece-container {
            text-align: center;
            margin-bottom: 25px;
        }
        
        #next-piece {
            background-color: #000;
            margin-top: 10px;
            transition: all 0.3s ease;
        }
        
        .game-status {
            text-align: center;
            font-size: 1.4rem;
            color: #ffcc00;
            margin-top: 15px;
            height: 30px;
            transition: all 0.3s ease;
        }
        
        .special-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: 5;
        }
        
        .color-wave {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                rgba(255, 0, 128, 0.2), 
                rgba(0, 204, 255, 0.2), 
                rgba(255, 204, 0, 0.2), 
                rgba(0, 255, 135, 0.2));
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            border-radius: 8px;
            z-index: 1;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .instructions {
            margin-top: 30px;
            font-size: 0.95rem;
            color: #aaa;
            line-height: 1.5;
            text-align: center;
        }
        
        .footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }
        
        .effect-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.8);
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            animation: fadeInOut 2s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); }
        }
        
        @media (max-width: 1100px) {
            .game-container {
                flex-direction: column;
                align-items: center;
            }
            
            .left-panel, .right-panel {
                width: 500px;
                max-width: 100%;
            }
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            
            .left-panel, .right-panel {
                padding: 15px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            /* 移動設備上防止滾動的額外樣式 */
            body {
                overflow-y: hidden;
                height: 100vh;
                position: fixed;
                width: 100%;
            }
        }
        
        /* 防止遊戲區域內的滾動 */
        .game-board, canvas, .left-panel, .right-panel {
            -webkit-overflow-scrolling: touch;
        }
        
        /* 移動端虛擬控制器 */
        .mobile-controller {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(20, 20, 30, 0.95);
            border-radius: 20px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .dpad-container {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .dpad {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .dpad-btn {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #2a2a3e, #16213e);
            border: 2px solid rgba(0, 204, 255, 0.3);
            border-radius: 8px;
            color: #00ccff;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .dpad-btn:active {
            background: linear-gradient(135deg, #00ccff, #0080cc);
            color: #fff;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(0, 204, 255, 0.6);
        }
        
        .dpad-btn.up { top: 0; left: 40px; }
        .dpad-btn.down { bottom: 0; left: 40px; }
        .dpad-btn.left { left: 0; top: 40px; }
        .dpad-btn.right { right: 0; top: 40px; }
        .dpad-btn.center { 
            top: 40px; 
            left: 40px;
            background: linear-gradient(135deg, #ff0080, #cc0066);
            border-color: rgba(255, 0, 128, 0.3);
            color: #fff;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .action-btn {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2a2a3e, #16213e);
            border: 2px solid rgba(255, 0, 128, 0.3);
            border-radius: 10px;
            color: #ff0080;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .action-btn:active {
            background: linear-gradient(135deg, #ff0080, #cc0066);
            color: #fff;
            transform: scale(0.95);
            box-shadow: 0 0 20px rgba(255, 0, 128, 0.6);
        }
        
        @media (max-width: 768px) {
            .mobile-controller {
                display: block;
            }
            
            /* 遊戲容器為移動端控制器留出空間 */
            .game-container {
                padding-bottom: 180px;
            }
        }
        
        /* 教程系統樣式 */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .tutorial-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .tutorial-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid rgba(0, 204, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .tutorial-overlay.active .tutorial-content {
            transform: scale(1);
        }
        
        .tutorial-title {
            color: #00ccff;
            font-size: 2rem;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 204, 255, 0.5);
        }
        
        .tutorial-description {
            color: #f0f0f0;
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .tutorial-navigation {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .tutorial-btn {
            background: linear-gradient(135deg, #00ccff, #0080cc);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }
        
        .tutorial-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 204, 255, 0.4);
        }
        
        .tutorial-btn:active {
            transform: translateY(0);
        }
        
        .tutorial-btn.skip {
            background: linear-gradient(135deg, #666, #444);
        }
        
        .tutorial-spotlight {
            position: absolute;
            pointer-events: none;
            border: 3px solid #00ccff;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
            z-index: 1999;
            animation: spotlightPulse 2s ease-in-out infinite;
        }
        
        @keyframes spotlightPulse {
            0%, 100% {
                box-shadow: 0 0 30px rgba(0, 204, 255, 0.8);
            }
            50% {
                box-shadow: 0 0 50px rgba(0, 204, 255, 1);
            }
        }
        
        .tutorial-hint {
            position: absolute;
            background: rgba(0, 204, 255, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 2001;
            animation: hintBounce 2s ease-in-out infinite;
        }
        
        @keyframes hintBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-5px);
            }
        }
        
        .tutorial-progress {
            margin-top: 20px;
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: #00ccff;
            transform: scale(1.3);
        }
        
        .progress-dot.completed {
            background: rgba(0, 204, 255, 0.6);
        }
        
        /* 粒子特效系統 */
        .particle-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        
        .particle {
            position: absolute;
            pointer-events: none;
            opacity: 1;
        }
        
        .clear-line-particle {
            width: 30px;
            height: 4px;
            background: linear-gradient(90deg, #00ccff, #ff0080);
            border-radius: 2px;
            animation: particleFly 1s ease-out forwards;
        }
        
        .merge-particle {
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #ffeb3b, #ff9800);
            border-radius: 50%;
            animation: mergeParticle 0.6s ease-out forwards;
        }
        
        .score-popup {
            position: absolute;
            color: #00ff88;
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.8);
            animation: scoreFloat 1.5s ease-out forwards;
            pointer-events: none;
            z-index: 1001;
        }
        
        @keyframes particleFly {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }
        
        @keyframes mergeParticle {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes scoreFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translateY(-20px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) scale(1);
                opacity: 0;
            }
        }
        
        /* 增強的分數動畫 */
        .score-animation {
            animation: scoreGlow 0.5s ease-out;
        }
        
        @keyframes scoreGlow {
            0% {
                transform: scale(1);
                text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }
            50% {
                transform: scale(1.3);
                text-shadow: 0 0 30px rgba(0, 255, 136, 1);
            }
            100% {
                transform: scale(1);
                text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            }
        }
        
        /* 方塊放置動畫 */
        .block-place-effect {
            animation: blockPlace 0.2s ease-out;
        }
        
        @keyframes blockPlace {
            0% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* 等級提升動畫 */
        .level-up-effect {
            animation: levelUpGlow 1s ease-out;
        }
        
        @keyframes levelUpGlow {
            0% {
                background: linear-gradient(135deg, #2a2a3e, #16213e);
            }
            50% {
                background: linear-gradient(135deg, #00ff88, #00cc66);
                box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
            }
            100% {
                background: linear-gradient(135deg, #2a2a3e, #16213e);
            }
        }
        
        /* 成就系統樣式 */
        .achievement-notification {
            position: fixed;
            top: 20px;
            right: -400px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid gold;
            border-radius: 15px;
            padding: 20px;
            min-width: 300px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 3000;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        .achievement-notification.show {
            right: 20px;
        }
        
        .achievement-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .achievement-icon {
            font-size: 2.5rem;
            margin-right: 15px;
            animation: achievementIconBounce 1s ease-in-out infinite;
        }
        
        @keyframes achievementIconBounce {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            50% {
                transform: scale(1.2) rotate(10deg);
            }
        }
        
        .achievement-title {
            color: gold;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .achievement-description {
            color: #f0f0f0;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .achievement-points {
            color: #00ccff;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        /* 成就面板 */
        .achievements-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2500;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .achievements-panel.active {
            display: flex;
        }
        
        .achievements-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid rgba(0, 204, 255, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            width: 90%;
            overflow-y: auto;
        }
        
        .achievements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }
        
        .achievements-title {
            color: #00ccff;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .achievements-close {
            background: none;
            border: none;
            color: #ff0080;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .achievements-close:hover {
            transform: scale(1.2);
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .achievement-card {
            background: rgba(20, 20, 30, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .achievement-card.unlocked {
            border-color: gold;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .achievement-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .achievement-card-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            filter: grayscale(1);
            opacity: 0.5;
        }
        
        .achievement-card.unlocked .achievement-card-icon {
            filter: grayscale(0);
            opacity: 1;
        }
        
        .achievement-card-title {
            color: #aaa;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .achievement-card.unlocked .achievement-card-title {
            color: gold;
        }
        
        .achievement-card-description {
            color: #888;
            font-size: 0.8rem;
        }
        
        .achievement-card.unlocked .achievement-card-description {
            color: #ddd;
        }
        
        .achievement-card-progress {
            margin-top: 10px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .achievement-card-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ccff, #ff0080);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .achievement-card-points {
            color: #666;
            font-size: 0.7rem;
            margin-top: 5px;
        }
        
        .achievement-card.unlocked .achievement-card-points {
            color: #00ccff;
        }
        
        /* 性能優化相關樣式 */
        .quality-low {
            /* 低質量模式 - 減少動畫和特效 */
        }
        
        .quality-low .particle-container,
        .quality-low .special-effect,
        .quality-low .tutorial-spotlight {
            display: none !important;
        }
        
        .quality-low * {
            animation-duration: 0.01ms !important;
            transition-duration: 0.01ms !important;
        }
        
        .quality-medium {
            /* 中等質量模式 - 部分特效 */
        }
        
        .quality-medium .particle-container {
            opacity: 0.7;
        }
        
        .quality-high {
            /* 高質量模式 - 所有特效 */
        }
        
        /* 性能監控面板（開發模式） */
        .performance-monitor {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            display: none;
        }
        
        .performance-monitor.active {
            display: block;
        }
        
        .performance-monitor div {
            margin: 2px 0;
        }
        
        /* 減少重繪的優化 */
        .game-board,
        canvas {
            will-change: transform;
            backface-visibility: hidden;
            perspective: 1000px;
        }
        
        /* 硬件加速優化 */
        .particle,
        .score-popup,
        .achievement-notification {
            transform: translateZ(0);
            will-change: transform, opacity;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>俄羅斯方塊 - 增強版</h1>
        <div class="subtitle">即時計分 + 最高分紀錄 + 全版圖消除特效</div>
    </div>
    
    <div class="game-container">
        <div class="left-panel">
            <div class="game-info">
                <div class="info-title">遊戲資訊</div>
                <div class="info-box">
                    <div class="info-item">
                        <span>當前分數:</span>
                        <span id="score" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span>最高分數:</span>
                        <span id="high-score" class="info-value high-score">0</span>
                    </div>
                    <div class="info-item">
                        <span>等級:</span>
                        <span id="level" class="info-value">1</span>
                    </div>
                    <div class="info-item">
                        <span>已消除行數:</span>
                        <span id="lines" class="info-value">0</span>
                    </div>
                    <div class="info-item">
                        <span>全版圖消除:</span>
                        <span id="full-clears" class="info-value">0</span>
                    </div>
                </div>
            </div>
            
            <div class="next-piece-container">
                <div class="info-title">下一個方塊</div>
                <canvas id="next-piece" width="150" height="150"></canvas>
            </div>
            
            <div class="game-status" id="game-status">遊戲準備中...</div>
            
            <div class="buttons">
                <button id="start-btn">開始遊戲</button>
                <button id="pause-btn">暫停遊戲</button>
                <button id="reset-btn">重新開始</button>
            </div>
        </div>
        
        <div class="game-board">
            <div class="special-effect" id="special-effect">
                <div class="color-wave"></div>
            </div>
            <canvas id="tetris" width="300" height="600"></canvas>
        </div>
        
        <div class="right-panel">
            <div class="info-title">遊戲控制</div>
            
            <div class="controls">
                <div class="control-item">
                    <div class="key">← →</div>
                    <div>左右移動方塊</div>
                </div>
                <div class="control-item">
                    <div class="key">↑</div>
                    <div>旋轉方塊</div>
                </div>
                <div class="control-item">
                    <div class="key">↓</div>
                    <div>加速下降</div>
                </div>
                <div class="control-item">
                    <div class="key">空格</div>
                    <div>直接落下</div>
                </div>
                <div class="control-item">
                    <div class="key">P</div>
                    <div>暫停/繼續</div>
                </div>
                <div class="control-item">
                    <div class="key">R</div>
                    <div>重新開始</div>
                </div>
            </div>
            
            <div class="instructions">
                <p><strong>計分規則:</strong></p>
                <p>• 消除 1 行: <span style="color:#ffcc00">+10 分</span></p>
                <p>• 消除 2 行: <span style="color:#ffcc00">+20 分</span></p>
                <p>• 消除 3 行: <span style="color:#ffcc00">+30 分</span></p>
                <p>• 全版圖消除 (4行): <span style="color:#ffcc00">+30 分 + 特效</span></p>
                <p><strong>特效:</strong> 全版圖消除後，背景和方塊會不斷變換顏色</p>
            </div>
        </div>
    </div>
    
    <div class="footer">
        使用HTML5 Canvas開發 | 俄羅斯方塊經典遊戲增強版
    </div>

    <script>
        // 遊戲常量
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        
        // 方塊顏色 - 基礎顏色
        const BASE_COLORS = [
            null,
            '#FF0B8E', // 粉红色
            '#00E8FF', // 青色
            '#FF7B00', // 橙色
            '#00FF87', // 绿色
            '#FF003C', // 红色
            '#9D00FF', // 紫色
            '#FFE600'  // 黄色
        ];
        
        // 方塊形狀定義
        const SHAPES = [
            null,
            [
                [0, 0, 0, 0],
                [1, 1, 1, 1],
                [0, 0, 0, 0],
                [0, 0, 0, 0]
            ],
            [
                [2, 0, 0],
                [2, 2, 2],
                [0, 0, 0]
            ],
            [
                [0, 0, 3],
                [3, 3, 3],
                [0, 0, 0]
            ],
            [
                [4, 4],
                [4, 4]
            ],
            [
                [0, 5, 5],
                [5, 5, 0],
                [0, 0, 0]
            ],
            [
                [0, 6, 0],
                [6, 6, 6],
                [0, 0, 0]
            ],
            [
                [7, 7, 0],
                [0, 7, 7],
                [0, 0, 0]
            ]
        ];

        // 遊戲變量
        let canvas = document.getElementById('tetris');
        let nextCanvas = document.getElementById('next-piece');
        let ctx = canvas.getContext('2d');
        let nextCtx = nextCanvas.getContext('2d');
        let board = [];
        let score = 0;
        let highScore = localStorage.getItem('tetrisHighScore') || 0;
        let level = 1;
        let lines = 0;
        let fullClears = 0;
        let gameOver = false;
        let paused = false;
        let dropCounter = 0;
        let dropInterval = 1000; // 初始下落間隔（毫秒）
        let lastTime = 0;
        let player = {
            pos: {x: 0, y: 0},
            matrix: null,
            score: 0
        };
        
        // 下一個方塊
        let nextPiece = null;
        
        // 特效相關變量
        let isSpecialEffectActive = false;
        let specialEffectTimer = 0;
        const SPECIAL_EFFECT_DURATION = 5000; // 特效持續時間（毫秒）
        let colorOffset = 0; // 顏色偏移量
        let effectNotificationActive = false;
        
        // 遊戲時間追蹤
        let gameStartTime = 0;
        
        // 音頻系統
        class GameAudio {
            constructor() {
                this.audioContext = null;
                this.initialized = false;
                this.masterVolume = 0.3;
            }
            
            init() {
                if (this.initialized) return;
                
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                } catch (e) {
                    console.log('音頻系統初始化失敗:', e);
                }
            }
            
            playTone(frequency, duration, type = 'sine', volume = 1) {
                if (!this.initialized) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.frequency.value = frequency;
                    oscillator.type = type;
                    
                    const actualVolume = volume * this.masterVolume;
                    gainNode.gain.setValueAtTime(actualVolume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                    
                    oscillator.start(this.audioContext.currentTime);
                    oscillator.stop(this.audioContext.currentTime + duration);
                } catch (e) {
                    console.log('音頻播放失敗:', e);
                }
            }
            
            playChord(frequencies, duration, volume = 1) {
                frequencies.forEach(freq => this.playTone(freq, duration, 'sine', volume * 0.7));
            }
            
            // 遊戲音效
            playMove() {
                this.playTone(200, 0.1, 'square', 0.5);
                this.triggerHaptic('short');
            }
            
            playRotate() {
                this.playTone(400, 0.1, 'sine', 0.6);
                this.triggerHaptic('short');
            }
            
            playDrop() {
                this.playTone(150, 0.2, 'triangle', 0.7);
                this.triggerHaptic('medium');
            }
            
            playClear(lines) {
                const baseFreq = 523; // C5
                const frequencies = [];
                
                if (lines >= 4) {
                    // Tetris! - 播放勝利和弦
                    frequencies.push(523, 659, 784, 1047); // C5, E5, G5, C6
                    this.playChord(frequencies, 0.8, 1);
                    this.triggerHaptic('success');
                } else {
                    // 普通消除
                    for (let i = 0; i < lines; i++) {
                        frequencies.push(baseFreq + (i * 100));
                    }
                    this.playChord(frequencies, 0.5, 0.8);
                    this.triggerHaptic('medium');
                }
            }
            
            playGameOver() {
                this.playTone(100, 1, 'sawtooth', 0.8);
                this.triggerHaptic('error');
            }
            
            playLevelUp() {
                this.playChord([523, 659, 784, 1047], 0.6, 1);
                this.triggerHaptic('success');
            }
            
            playSpecialEffect() {
                // 特殊效果音效
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        this.playChord([440, 554, 659], 0.3, 0.9);
                    }, i * 100);
                }
                this.triggerHaptic('success');
            }
            
            triggerHaptic(pattern = 'short') {
                if ('vibrate' in navigator) {
                    const patterns = {
                        short: [10],
                        medium: [50],
                        long: [100],
                        success: [50, 50, 50],
                        error: [100, 50, 100]
                    };
                    navigator.vibrate(patterns[pattern] || patterns.short);
                }
            }
            
            setVolume(volume) {
                this.masterVolume = Math.max(0, Math.min(1, volume));
            }
        }
        
        // 初始化音頻系統
        const gameAudio = new GameAudio();
        
        // 移動端控制器
        class MobileControls {
            constructor() {
                this.isMobile = this.detectMobile();
                this.controller = null;
                this.swipeStartX = 0;
                this.swipeStartY = 0;
                this.swipeThreshold = 30; // 降低門檻以提高響應性
                this.init();
            }
            
            detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       (window.innerWidth <= 768 && 'ontouchstart' in window);
            }
            
            init() {
                if (!this.isMobile) return;
                
                this.controller = document.getElementById('mobile-controller');
                this.setupControllerListeners();
                this.setupSwipeGestures();
                this.setupTouchPrevention();
            }
            
            setupControllerListeners() {
                const buttons = this.controller.querySelectorAll('[data-action]');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        const action = button.dataset.action;
                        this.handleAction(action);
                    });
                    
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        const action = button.dataset.action;
                        this.handleAction(action);
                    });
                });
            }
            
            setupSwipeGestures() {
                const gameBoard = document.querySelector('.game-board');
                
                gameBoard.addEventListener('touchstart', (e) => {
                    this.swipeStartX = e.touches[0].clientX;
                    this.swipeStartY = e.touches[0].clientY;
                }, { passive: true });
                
                gameBoard.addEventListener('touchend', (e) => {
                    if (!this.swipeStartX || !this.swipeStartY) return;
                    
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    
                    const deltaX = touchEndX - this.swipeStartX;
                    const deltaY = touchEndY - this.swipeStartY;
                    
                    if (Math.abs(deltaX) > Math.abs(deltaY)) {
                        // 水平滑動
                        if (Math.abs(deltaX) > this.swipeThreshold) {
                            this.handleAction(deltaX > 0 ? 'right' : 'left');
                        }
                    } else {
                        // 垂直滑動
                        if (Math.abs(deltaY) > this.swipeThreshold) {
                            if (deltaY > 0) {
                                // 向下滑動 - 硬降
                                this.handleAction('harddrop');
                            } else {
                                // 向上滑動 - 旋轉
                                this.handleAction('rotate');
                            }
                        }
                    }
                    
                    this.swipeStartX = 0;
                    this.swipeStartY = 0;
                }, { passive: true });
            }
            
            setupTouchPrevention() {
                // 防止遊戲區域的默認觸摸行為
                const canvas = document.getElementById('tetris');
                canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
                canvas.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
            }
            
            handleAction(action) {
                switch (action) {
                    case 'left':
                        playerMove(-1);
                        break;
                    case 'right':
                        playerMove(1);
                        break;
                    case 'down':
                        playerDrop();
                        break;
                    case 'rotate':
                        playerRotate(1);
                        break;
                    case 'harddrop':
                        playerHardDrop();
                        break;
                    case 'pause':
                        togglePause();
                        break;
                }
            }
        }
        
        // 初始化移動端控制器
        const mobileControls = new MobileControls();
        
        // 教程系統
        class TutorialSystem {
            constructor() {
                this.currentStep = 0;
                this.overlay = document.getElementById('tutorial-overlay');
                this.titleElement = document.getElementById('tutorial-title');
                this.descriptionElement = document.getElementById('tutorial-description');
                this.progressElement = document.getElementById('tutorial-progress');
                this.nextBtn = document.getElementById('tutorial-next');
                this.skipBtn = document.getElementById('tutorial-skip');
                this.isActive = false;
                this.hasCompleted = localStorage.getItem('tetrisTutorialCompleted') === 'true';
                
                this.steps = [
                    {
                        title: '歡迎來到俄羅斯方塊！',
                        description: '這是經典的俄羅斯方塊遊戲，目標是消除完整行來得分。讓我們學習基本操作！',
                        target: null,
                        spotlight: false
                    },
                    {
                        title: '移動控制',
                        description: '使用左右方向鍵 (← →) 來移動方塊。在移動設備上，你可以使用虛擬控制器或滑動手勢。',
                        target: '.game-board',
                        spotlight: true
                    },
                    {
                        title: '旋轉方塊',
                        description: '按向上方向鍵 (↑) 或旋轉按鈕來旋轉方塊。合理旋轉可以幫助方塊更好地放置。',
                        target: '.dpad-btn.center',
                        spotlight: true
                    },
                    {
                        title: '快速下落',
                        description: '按向下方向鍵 (↓) 加速下落，或使用空格鍵直接落到底部。移動設備上可以向上滑動旋轉，向下滑動快速下落。',
                        target: '.action-btn.drop',
                        spotlight: true
                    },
                    {
                        title: '得分系統',
                        description: '消除行數越多，得分越高！一次消除4行（Tetris）會獲得額外分數和特殊特效！',
                        target: '.info-box',
                        spotlight: true
                    },
                    {
                        title: '等級系統',
                        description: '每消除10行升一級，等級越高遊戲速度越快。挑戰自己看看能達到多少級！',
                        target: '.info-box',
                        spotlight: true
                    },
                    {
                        title: '準備好了！',
                        description: '現在你已經掌握了基本操作。記住：思考要快，操作要準準。祝你遊戲愉快！',
                        target: null,
                        spotlight: false
                    }
                ];
                
                this.init();
            }
            
            init() {
                if (this.hasCompleted) return;
                
                this.setupEventListeners();
                
                // 延遲顯示教程，讓用戶先看到遊戲界面
                setTimeout(() => {
                    this.start();
                }, 1000);
            }
            
            setupEventListeners() {
                this.nextBtn.addEventListener('click', () => this.nextStep());
                this.skipBtn.addEventListener('click', () => this.skip());
                
                // 鍵盤快捷鍵
                document.addEventListener('keydown', (e) => {
                    if (!this.isActive) return;
                    
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.nextStep();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        this.skip();
                    }
                });
            }
            
            start() {
                this.isActive = true;
                this.currentStep = 0;
                this.overlay.classList.add('active');
                this.showStep();
                gameAudio.init();
            }
            
            showStep() {
                const step = this.steps[this.currentStep];
                if (!step) {
                    this.complete();
                    return;
                }
                
                // 更新內容
                this.titleElement.textContent = step.title;
                this.descriptionElement.textContent = step.description;
                
                // 更新進度指示器
                this.updateProgress();
                
                // 更新按鈕文字
                if (this.currentStep === this.steps.length - 1) {
                    this.nextBtn.textContent = '開始遊戲';
                } else {
                    this.nextBtn.textContent = '下一步';
                }
                
                // 顯示聚光燈效果
                if (step.target && step.spotlight) {
                    this.showSpotlight(step.target);
                } else {
                    this.hideSpotlight();
                }
            }
            
            updateProgress() {
                this.progressElement.innerHTML = '';
                for (let i = 0; i < this.steps.length; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'progress-dot';
                    
                    if (i < this.currentStep) {
                        dot.classList.add('completed');
                    } else if (i === this.currentStep) {
                        dot.classList.add('active');
                    }
                    
                    this.progressElement.appendChild(dot);
                }
            }
            
            showSpotlight(selector) {
                this.hideSpotlight();
                
                const target = document.querySelector(selector);
                if (!target) return;
                
                const rect = target.getBoundingClientRect();
                const spotlight = document.createElement('div');
                spotlight.className = 'tutorial-spotlight';
                spotlight.style.left = rect.left - 5 + 'px';
                spotlight.style.top = rect.top - 5 + 'px';
                spotlight.style.width = rect.width + 10 + 'px';
                spotlight.style.height = rect.height + 10 + 'px';
                
                document.body.appendChild(spotlight);
                
                // 添加提示文字
                const hint = document.createElement('div');
                hint.className = 'tutorial-hint';
                hint.textContent = '看這裡！';
                hint.style.left = rect.right + 10 + 'px';
                hint.style.top = rect.top + 'px';
                
                document.body.appendChild(hint);
                
                // 動畫後移除提示
                setTimeout(() => {
                    hint.remove();
                }, 2000);
            }
            
            hideSpotlight() {
                const spotlight = document.querySelector('.tutorial-spotlight');
                const hint = document.querySelector('.tutorial-hint');
                if (spotlight) spotlight.remove();
                if (hint) hint.remove();
            }
            
            nextStep() {
                this.currentStep++;
                
                if (this.currentStep >= this.steps.length) {
                    this.complete();
                } else {
                    this.showStep();
                    gameAudio.playMove();
                }
            }
            
            skip() {
                this.complete();
            }
            
            complete() {
                this.isActive = false;
                this.overlay.classList.remove('active');
                this.hideSpotlight();
                
                // 標記教程已完成
                localStorage.setItem('tetrisTutorialCompleted', 'true');
                this.hasCompleted = true;
                
                // 播放完成音效
                gameAudio.playLevelUp();
                
                // 聚焦到遊戲
                document.getElementById('tetris').focus();
            }
            
            // 可以從外部調用重新開始教程
            restart() {
                localStorage.removeItem('tetrisTutorialCompleted');
                this.hasCompleted = false;
                this.start();
            }
        }
        
        // 初始化教程系統
        const tutorialSystem = new TutorialSystem();
        
        // 粒子特效系統
        class ParticleSystem {
            constructor() {
                this.container = document.getElementById('particle-container');
                this.particles = [];
                this.maxParticles = this.getMaxParticles();
            }
            
            getMaxParticles() {
                // 根據設備性能動態調整粒子數量
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                const isLowEnd = navigator.hardwareConcurrency <= 2 || navigator.deviceMemory <= 2;
                
                if (isMobile || isLowEnd) {
                    return 30; // 低端設備限制粒子數
                }
                return 60; // 高端設備使用更多粒子
            }
            
            createClearLineEffect(y, rowCount) {
                const canvas = document.getElementById('tetris');
                const rect = canvas.getBoundingClientRect();
                const blockSize = 30;
                
                for (let i = 0; i < rowCount * 8; i++) {
                    if (this.particles.length >= this.maxParticles) break;
                    
                    const particle = document.createElement('div');
                    particle.className = 'particle clear-line-particle';
                    
                    // 隨機位置在消除行的範圍內
                    const x = Math.random() * 10 * blockSize;
                    const targetX = (Math.random() - 0.5) * 200;
                    const targetY = -Math.random() * 100 - 50;
                    
                    particle.style.left = rect.left + x + 'px';
                    particle.style.top = rect.top + y * blockSize + 'px';
                    particle.style.setProperty('--tx', targetX + 'px');
                    particle.style.setProperty('--ty', targetY + 'px');
                    
                    // 隨機延遲創建連續效果
                    particle.style.animationDelay = (Math.random() * 0.3) + 's';
                    
                    this.container.appendChild(particle);
                    this.particles.push(particle);
                    
                    // 自動清理
                    setTimeout(() => {
                        particle.remove();
                        this.particles = this.particles.filter(p => p !== particle);
                    }, 1300);
                }
            }
            
            createMergeEffect(x, y) {
                const canvas = document.getElementById('tetris');
                const rect = canvas.getBoundingClientRect();
                const blockSize = 30;
                
                for (let i = 0; i < 5; i++) {
                    if (this.particles.length >= this.maxParticles) break;
                    
                    const particle = document.createElement('div');
                    particle.className = 'particle merge-particle';
                    
                    const offsetX = (Math.random() - 0.5) * blockSize;
                    const offsetY = (Math.random() - 0.5) * blockSize;
                    
                    particle.style.left = rect.left + x * blockSize + blockSize/2 + offsetX + 'px';
                    particle.style.top = rect.top + y * blockSize + blockSize/2 + offsetY + 'px';
                    
                    this.container.appendChild(particle);
                    this.particles.push(particle);
                    
                    setTimeout(() => {
                        particle.remove();
                        this.particles = this.particles.filter(p => p !== particle);
                    }, 600);
                }
            }
            
            createScorePopup(points, x, y) {
                const canvas = document.getElementById('tetris');
                const rect = canvas.getBoundingClientRect();
                const blockSize = 30;
                
                const popup = document.createElement('div');
                popup.className = 'score-popup';
                popup.textContent = '+' + points;
                
                popup.style.left = rect.left + x * blockSize + 'px';
                popup.style.top = rect.top + y * blockSize + 'px';
                
                this.container.appendChild(popup);
                
                setTimeout(() => {
                    popup.remove();
                }, 1500);
            }
            
            createBlockPlaceEffect(x, y) {
                const canvas = document.getElementById('tetris');
                const rect = canvas.getBoundingClientRect();
                const blockSize = 30;
                
                this.createMergeEffect(x, y);
            }
            
            createLevelUpEffect() {
                // 為整個遊戲板添加閃光效果
                const gameBoard = document.querySelector('.game-board');
                gameBoard.classList.add('level-up-effect');
                
                // 創建慶祝粒子
                const canvas = document.getElementById('tetris');
                const rect = canvas.getBoundingClientRect();
                
                for (let i = 0; i < 20; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle merge-particle';
                        
                        particle.style.left = rect.left + Math.random() * rect.width + 'px';
                        particle.style.top = rect.top + rect.height + 'px';
                        
                        particle.style.setProperty('--tx', (Math.random() - 0.5) * 200 + 'px');
                        particle.style.setProperty('--ty', -Math.random() * 200 - 100 + 'px');
                        particle.style.background = `radial-gradient(circle, 
                            hsl(${Math.random() * 360}, 100%, 50%), 
                            hsl(${Math.random() * 360}, 100%, 50%))`;
                        
                        this.container.appendChild(particle);
                        this.particles.push(particle);
                        
                        setTimeout(() => {
                            particle.remove();
                            this.particles = this.particles.filter(p => p !== particle);
                        }, 600);
                    }, i * 50);
                }
                
                setTimeout(() => {
                    gameBoard.classList.remove('level-up-effect');
                }, 1000);
            }
            
            // 清理所有粒子
            clearAll() {
                this.particles.forEach(particle => particle.remove());
                this.particles = [];
            }
        }
        
        // 初始化粒子系統
        const particleSystem = new ParticleSystem();
        
        // 成就系統
        class AchievementSystem {
            constructor() {
                this.achievements = this.loadAchievements();
                this.notification = document.getElementById('achievement-notification');
                this.panel = document.getElementById('achievements-panel');
                this.grid = document.getElementById('achievements-grid');
                this.totalPoints = parseInt(localStorage.getItem('tetrisAchievementPoints') || '0');
                this.init();
            }
            
            loadAchievements() {
                const saved = localStorage.getItem('tetrisAchievements');
                if (saved) {
                    return JSON.parse(saved);
                }
                
                return [
                    {
                        id: 'first_line',
                        title: '初學者',
                        description: '消除你的第一行',
                        icon: '🎯',
                        points: 10,
                        unlocked: false,
                        condition: () => lines >= 1
                    },
                    {
                        id: 'tetris_master',
                        title: '俄羅斯方塊大師',
                        description: '一次消除4行（Tetris）',
                        icon: '👑',
                        points: 50,
                        unlocked: false,
                        condition: () => fullClears >= 1
                    },
                    {
                        id: 'score_100',
                        title: '百分達人',
                        description: '得分超過100分',
                        icon: '💯',
                        points: 20,
                        unlocked: false,
                        condition: () => score >= 100
                    },
                    {
                        id: 'score_500',
                        title: '高分玩家',
                        description: '得分超過500分',
                        icon: '🌟',
                        points: 30,
                        unlocked: false,
                        condition: () => score >= 500
                    },
                    {
                        id: 'score_1000',
                        title: '千分達人',
                        description: '得分超過1000分',
                        icon: '⭐',
                        points: 50,
                        unlocked: false,
                        condition: () => score >= 1000
                    },
                    {
                        id: 'level_5',
                        title: '進階玩家',
                        description: '達到等級5',
                        icon: '📈',
                        points: 25,
                        unlocked: false,
                        condition: () => level >= 5
                    },
                    {
                        id: 'level_10',
                        title: '專家玩家',
                        description: '達到等級10',
                        icon: '🚀',
                        points: 40,
                        unlocked: false,
                        condition: () => level >= 10
                    },
                    {
                        id: 'lines_10',
                        title: '消除新手',
                        description: '累計消除10行',
                        icon: '📊',
                        points: 15,
                        unlocked: false,
                        condition: () => lines >= 10
                    },
                    {
                        id: 'lines_50',
                        title: '消除專家',
                        description: '累計消除50行',
                        icon: '📈',
                        points: 30,
                        unlocked: false,
                        condition: () => lines >= 50
                    },
                    {
                        id: 'speed_demon',
                        title: '极速玩家',
                        description: '在等級3以上得分超過300',
                        icon: '⚡',
                        points: 35,
                        unlocked: false,
                        condition: () => level >= 3 && score >= 300
                    },
                    {
                        id: 'perfect_clear',
                        title: '完美清除',
                        description: '連續3次消除4行',
                        icon: '💎',
                        points: 100,
                        unlocked: false,
                        condition: () => false, // 需要特殊追蹤
                        special: true
                    },
                    {
                        id: 'survivor',
                        title: '生存專家',
                        description: '遊戲時間超過5分鐘',
                        icon: '⏰',
                        points: 25,
                        unlocked: false,
                        condition: () => false, // 需要時間追蹤
                        special: true
                    },
                    {
                        id: 'comeback_king',
                        title: '逆轉之王',
                        description: '在分數低於50時得分超過500',
                        icon: '👑',
                        points: 60,
                        unlocked: false,
                        condition: () => false, // 需要特殊追蹤
                        special: true
                    }
                ];
            }
            
            init() {
                this.setupEventListeners();
                this.updateAchievementsPanel();
            }
            
            setupEventListeners() {
                // 成就面板關閉按鈕
                document.getElementById('achievements-close').addEventListener('click', () => {
                    this.panel.classList.remove('active');
                });
                
                // 鍵盤快捷鍵 (A鍵打開成就面板)
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'a' || e.key === 'A') {
                        if (!this.panel.classList.contains('active')) {
                            this.showPanel();
                        } else {
                            this.panel.classList.remove('active');
                        }
                    }
                });
            }
            
            checkAchievements() {
                let newUnlocks = [];
                
                this.achievements.forEach(achievement => {
                    if (!achievement.unlocked && achievement.condition()) {
                        achievement.unlocked = true;
                        newUnlocks.push(achievement);
                        this.totalPoints += achievement.points;
                    }
                });
                
                if (newUnlocks.length > 0) {
                    this.saveAchievements();
                    newUnlocks.forEach(achievement => {
                        this.showUnlockNotification(achievement);
                    });
                    this.updateAchievementsPanel();
                }
            }
            
            showUnlockNotification(achievement) {
                const titleElement = document.getElementById('achievement-title');
                const descriptionElement = document.getElementById('achievement-description');
                const pointsElement = document.getElementById('achievement-points');
                
                titleElement.textContent = '🏆 ' + achievement.title;
                descriptionElement.textContent = achievement.description;
                pointsElement.textContent = '+' + achievement.points + ' 經驗值';
                
                this.notification.classList.add('show');
                
                // 播放成就解鎖音效
                gameAudio.playLevelUp();
                gameAudio.triggerHaptic('success');
                
                // 創建慶祝粒子效果
                particleSystem.createLevelUpEffect();
                
                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 4000);
            }
            
            showPanel() {
                this.updateAchievementsPanel();
                this.panel.classList.add('active');
            }
            
            updateAchievementsPanel() {
                this.grid.innerHTML = '';
                
                this.achievements.forEach(achievement => {
                    const card = document.createElement('div');
                    card.className = 'achievement-card';
                    if (achievement.unlocked) {
                        card.classList.add('unlocked');
                    }
                    
                    card.innerHTML = `
                        <div class="achievement-card-icon">${achievement.icon}</div>
                        <div class="achievement-card-title">${achievement.title}</div>
                        <div class="achievement-card-description">${achievement.description}</div>
                        <div class="achievement-card-points">+${achievement.points} 經驗值</div>
                    `;
                    
                    this.grid.appendChild(card);
                });
            }
            
            saveAchievements() {
                localStorage.setItem('tetrisAchievements', JSON.stringify(this.achievements));
                localStorage.setItem('tetrisAchievementPoints', this.totalPoints.toString());
            }
            
            // 特殊成就追蹤方法
            trackPerfectClear() {
                const perfectClears = parseInt(localStorage.getItem('tetrisPerfectClears') || '0');
                localStorage.setItem('tetrisPerfectClears', (perfectClears + 1).toString());
                
                if (perfectClears + 1 >= 3) {
                    const achievement = this.achievements.find(a => a.id === 'perfect_clear');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        this.totalPoints += achievement.points;
                        this.showUnlockNotification(achievement);
                        this.saveAchievements();
                    }
                }
            }
            
            trackGameTime(timeInSeconds) {
                if (timeInSeconds >= 300) { // 5分鐘
                    const achievement = this.achievements.find(a => a.id === 'survivor');
                    if (achievement && !achievement.unlocked) {
                        achievement.unlocked = true;
                        this.totalPoints += achievement.points;
                        this.showUnlockNotification(achievement);
                        this.saveAchievements();
                    }
                }
            }
            
            getTotalPoints() {
                return this.totalPoints;
            }
            
            getUnlockedCount() {
                return this.achievements.filter(a => a.unlocked).length;
            }
        }
        
        // 初始化成就系統
        const achievementSystem = new AchievementSystem();
        
        // 性能優化系統
        class PerformanceOptimizer {
            constructor() {
                this.targetFPS = 60;
                this.frameTime = 1000 / this.targetFPS;
                this.lastFrameTime = 0;
                this.fpsHistory = [];
                this.maxHistoryLength = 60;
                this.qualityLevel = 'high';
                this.isLowEndDevice = this.detectLowEndDevice();
                this.isMobile = this.detectMobile();
                this.adaptiveQuality = true;
                
                this.init();
            }
            
            detectLowEndDevice() {
                // 檢測低端設備
                const cores = navigator.hardwareConcurrency || 4;
                const memory = navigator.deviceMemory || 4;
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                
                return cores <= 2 || memory <= 2 || 
                       (connection && connection.effectiveType && 
                        ['slow-2g', '2g', '3g'].includes(connection.effectiveType));
            }
            
            detectMobile() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                       window.innerWidth <= 768;
            }
            
            init() {
                // 根據設備能力設置初始質量級別
                if (this.isLowEndDevice) {
                    this.qualityLevel = 'low';
                    this.applyQualitySettings();
                } else if (this.isMobile) {
                    this.qualityLevel = 'medium';
                    this.applyQualitySettings();
                } else {
                    this.qualityLevel = 'high';
                }
                
                // 監控性能
                this.startPerformanceMonitoring();
            }
            
            startPerformanceMonitoring() {
                // 每5秒檢查一次性能
                setInterval(() => {
                    this.checkPerformance();
                }, 5000);
            }
            
            checkPerformance() {
                if (this.fpsHistory.length < 10) return;
                
                const avgFPS = this.fpsHistory.slice(-10).reduce((a, b) => a + b, 0) / 10;
                
                if (avgFPS < 30 && this.qualityLevel !== 'low') {
                    // 性能不足，降低質量
                    this.downgradeQuality();
                } else if (avgFPS > 50 && this.qualityLevel === 'low') {
                    // 性能良好，可以提升質量
                    this.upgradeQuality();
                }
            }
            
            downgradeQuality() {
                const levels = ['high', 'medium', 'low'];
                const currentIndex = levels.indexOf(this.qualityLevel);
                if (currentIndex < levels.length - 1) {
                    this.qualityLevel = levels[currentIndex + 1];
                    this.applyQualitySettings();
                    console.log(`性能優化：降低質量到 ${this.qualityLevel}`);
                }
            }
            
            upgradeQuality() {
                const levels = ['high', 'medium', 'low'];
                const currentIndex = levels.indexOf(this.qualityLevel);
                if (currentIndex > 0) {
                    this.qualityLevel = levels[currentIndex - 1];
                    this.applyQualitySettings();
                    console.log(`性能優化：提升質量到 ${this.qualityLevel}`);
                }
            }
            
            applyQualitySettings() {
                const body = document.body;
                
                // 移除所有質量類
                body.classList.remove('quality-low', 'quality-medium', 'quality-high');
                
                switch (this.qualityLevel) {
                    case 'low':
                        body.classList.add('quality-low');
                        // 減少粒子數量
                        particleSystem.maxParticles = 20;
                        // 禁用某些特效
                        this.disableHeavyEffects();
                        break;
                    case 'medium':
                        body.classList.add('quality-medium');
                        particleSystem.maxParticles = 40;
                        this.enableMediumEffects();
                        break;
                    case 'high':
                        body.classList.add('quality-high');
                        particleSystem.maxParticles = 60;
                        this.enableAllEffects();
                        break;
                }
            }
            
            disableHeavyEffects() {
                // 禁用重型特效
                const style = document.createElement('style');
                style.id = 'performance-override';
                style.textContent = `
                    .particle-container { display: none !important; }
                    .special-effect { display: none !important; }
                    .tutorial-spotlight { display: none !important; }
                    * { animation-duration: 0.01ms !important; }
                `;
                
                // 移除現有的性能覆蓋樣式
                const existing = document.getElementById('performance-override');
                if (existing) existing.remove();
                
                document.head.appendChild(style);
            }
            
            enableMediumEffects() {
                const existing = document.getElementById('performance-override');
                if (existing) existing.remove();
            }
            
            enableAllEffects() {
                const existing = document.getElementById('performance-override');
                if (existing) existing.remove();
            }
            
            recordFrame(timestamp) {
                if (this.lastFrameTime === 0) {
                    this.lastFrameTime = timestamp;
                    return;
                }
                
                const frameTime = timestamp - this.lastFrameTime;
                const fps = 1000 / frameTime;
                
                this.fpsHistory.push(fps);
                if (this.fpsHistory.length > this.maxHistoryLength) {
                    this.fpsHistory.shift();
                }
                
                this.lastFrameTime = timestamp;
            }
            
            getQualityLevel() {
                return this.qualityLevel;
            }
            
            getFPS() {
                if (this.fpsHistory.length === 0) return 0;
                return this.fpsHistory[this.fpsHistory.length - 1];
            }
            
            getAverageFPS() {
                if (this.fpsHistory.length === 0) return 0;
                return this.fpsHistory.reduce((a, b) => a + b, 0) / this.fpsHistory.length;
            }
            
            // 手動設置質量級別
            setQualityLevel(level) {
                if (['low', 'medium', 'high'].includes(level)) {
                    this.qualityLevel = level;
                    this.applyQualitySettings();
                    console.log(`手動設置質量級別：${level}`);
                }
            }
            
            // 獲取設備信息
            getDeviceInfo() {
                return {
                    isLowEnd: this.isLowEndDevice,
                    isMobile: this.isMobile,
                    cores: navigator.hardwareConcurrency || 'unknown',
                    memory: navigator.deviceMemory || 'unknown',
                    connection: navigator.connection?.effectiveType || 'unknown',
                    currentFPS: this.getFPS(),
                    averageFPS: this.getAverageFPS(),
                    qualityLevel: this.qualityLevel
                };
            }
        }
        
        // 初始化性能優化系統
        const performanceOptimizer = new PerformanceOptimizer();
        
        // 性能監控面板（開發模式）
        class PerformanceMonitor {
            constructor() {
                this.panel = document.getElementById('performance-monitor');
                this.fpsDisplay = document.getElementById('fps-display');
                this.avgFpsDisplay = document.getElementById('avg-fps-display');
                this.qualityDisplay = document.getElementById('quality-display');
                this.particleCountDisplay = document.getElementById('particle-count');
                this.deviceTypeDisplay = document.getElementById('device-type');
                this.isVisible = false;
                this.updateInterval = null;
                
                this.init();
            }
            
            init() {
                // 開發者快捷鍵（F12 或 P鍵切換顯示）
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'F12' || (e.key === 'p' && e.ctrlKey)) {
                        e.preventDefault();
                        this.toggle();
                    }
                });
            }
            
            toggle() {
                this.isVisible = !this.isVisible;
                if (this.isVisible) {
                    this.panel.classList.add('active');
                    this.startUpdating();
                } else {
                    this.panel.classList.remove('active');
                    this.stopUpdating();
                }
            }
            
            startUpdating() {
                this.update(); // 立即更新一次
                this.updateInterval = setInterval(() => this.update(), 100);
            }
            
            stopUpdating() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            }
            
            update() {
                // 更新FPS顯示
                this.fpsDisplay.textContent = performanceOptimizer.getFPS().toFixed(1);
                this.avgFpsDisplay.textContent = performanceOptimizer.getAverageFPS().toFixed(1);
                
                // 更新質量級別
                this.qualityDisplay.textContent = performanceOptimizer.getQualityLevel();
                
                // 更新粒子數量
                this.particleCountDisplay.textContent = particleSystem.particles.length;
                
                // 更新設備類型
                const deviceInfo = performanceOptimizer.getDeviceInfo();
                this.deviceTypeDisplay.textContent = 
                    deviceInfo.isMobile ? 'mobile' : 
                    deviceInfo.isLowEnd ? 'low-end' : 'desktop';
                
                // 根據性能狀態改變顏色
                const fps = performanceOptimizer.getFPS();
                if (fps < 20) {
                    this.fpsDisplay.style.color = '#ff0000';
                } else if (fps < 30) {
                    this.fpsDisplay.style.color = '#ffaa00';
                } else {
                    this.fpsDisplay.style.color = '#00ff00';
                }
            }
            
            show() {
                if (!this.isVisible) {
                    this.toggle();
                }
            }
            
            hide() {
                if (this.isVisible) {
                    this.toggle();
                }
            }
        }
        
        // 初始化性能監控面板
        const performanceMonitor = new PerformanceMonitor();
        
        // 初始化遊戲
        function init() {
            // 初始化音頻系統
            gameAudio.init();
            
            board = createMatrix(COLS, ROWS);
            player.score = 0;
            score = 0;
            level = 1;
            lines = 0;
            fullClears = 0;
            gameOver = false;
            paused = false;
            dropInterval = 1000;
            isSpecialEffectActive = false;
            specialEffectTimer = 0;
            colorOffset = 0;
            
            // 遊戲時間追蹤
            gameStartTime = Date.now();
            
            // 停止特效
            stopSpecialEffect();
            
            // 初始化玩家方塊
            player.matrix = createPiece().matrix;
            player.pos.y = 0;
            player.pos.x = Math.floor(COLS / 2) - Math.floor(player.matrix[0].length / 2);
            
            // 初始化下一個方塊
            nextPiece = createPiece();
            
            // 更新顯示
            updateScore();
            drawNextPiece();
            
            // 重置遊戲狀態顯示
            document.getElementById('game-status').textContent = '遊戲準備中...';
            document.getElementById('game-status').style.color = '#ffcc00';
            
            // 繪製初始遊戲板
            drawBoard();
        }

        // 初始化遊戲板
        function createMatrix(w, h) {
            const matrix = [];
            while (h--) {
                matrix.push(new Array(w).fill(0));
            }
            return matrix;
        }

        // 創建一個隨機方塊
        function createPiece() {
            const pieceId = Math.floor(Math.random() * 7) + 1;
            return {
                matrix: SHAPES[pieceId],
                colorId: pieceId
            };
        }
        
        // 根據特效狀態獲取顏色
        function getColor(colorId) {
            if (!isSpecialEffectActive || colorId === 0) {
                return BASE_COLORS[colorId];
            }
            
            // 特效激活時，動態計算顏色
            const hue = (colorOffset + (colorId * 50)) % 360;
            return `hsl(${hue}, 100%, 60%)`;
        }
        
        // 根據特效狀態獲取背景顏色
        function getBackgroundColor() {
            if (!isSpecialEffectActive) {
                return '#000';
            }
            
            // 特效激活時，動態背景色
            const hue = (colorOffset + 180) % 360;
            return `hsl(${hue}, 70%, 10%)`;
        }

        // 繪製單個方塊
        function drawBlock(ctx, x, y, colorId) {
            const color = getColor(colorId);
            if (!color) return;
            
            // 方塊主體
            ctx.fillStyle = color;
            ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            
            // 方塊邊框
            ctx.strokeStyle = isSpecialEffectActive ? '#ffffff' : '#ffffff';
            ctx.lineWidth = 1;
            ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            
            // 方塊內部高光效果
            ctx.fillStyle = isSpecialEffectActive ? 'rgba(255, 255, 255, 0.4)' : 'rgba(255, 255, 255, 0.2)';
            ctx.fillRect(x * BLOCK_SIZE + 2, y * BLOCK_SIZE + 2, BLOCK_SIZE - 4, 6);
            ctx.fillRect(x * BLOCK_SIZE + 2, y * BLOCK_SIZE + 2, 6, BLOCK_SIZE - 4);
            
            // 方塊陰影效果
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(x * BLOCK_SIZE + 8, y * BLOCK_SIZE + BLOCK_SIZE - 6, BLOCK_SIZE - 8, 6);
            ctx.fillRect(x * BLOCK_SIZE + BLOCK_SIZE - 6, y * BLOCK_SIZE + 8, 6, BLOCK_SIZE - 8);
        }

        // 繪製遊戲板
        function drawBoard() {
            // 繪製背景
            ctx.fillStyle = getBackgroundColor();
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 繪製網格
            ctx.strokeStyle = isSpecialEffectActive ? 'rgba(255, 255, 255, 0.3)' : 'rgba(100, 100, 100, 0.2)';
            ctx.lineWidth = 0.5;
            
            // 垂直線
            for (let x = 0; x <= COLS; x++) {
                ctx.beginPath();
                ctx.moveTo(x * BLOCK_SIZE, 0);
                ctx.lineTo(x * BLOCK_SIZE, ROWS * BLOCK_SIZE);
                ctx.stroke();
            }
            
            // 水平線
            for (let y = 0; y <= ROWS; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * BLOCK_SIZE);
                ctx.lineTo(COLS * BLOCK_SIZE, y * BLOCK_SIZE);
                ctx.stroke();
            }
            
            // 繪製已落下的方塊
            for (let y = 0; y < board.length; y++) {
                for (let x = 0; x < board[y].length; x++) {
                    if (board[y][x]) {
                        drawBlock(ctx, x, y, board[y][x]);
                    }
                }
            }
            
            // 繪製當前下落的方塊
            if (player.matrix) {
                for (let y = 0; y < player.matrix.length; y++) {
                    for (let x = 0; x < player.matrix[y].length; x++) {
                        if (player.matrix[y][x]) {
                            drawBlock(ctx, x + player.pos.x, y + player.pos.y, player.matrix[y][x]);
                        }
                    }
                }
            }
        }

        // 繪製下一個方塊預覽
        function drawNextPiece() {
            // 清除畫布
            nextCtx.fillStyle = isSpecialEffectActive ? getBackgroundColor() : '#000';
            nextCtx.fillRect(0, 0, nextCanvas.width, nextCanvas.height);
            
            if (!nextPiece) return;
            
            const matrix = nextPiece.matrix;
            const offsetX = (nextCanvas.width / BLOCK_SIZE - matrix[0].length) / 2;
            const offsetY = (nextCanvas.height / BLOCK_SIZE - matrix.length) / 2;
            
            for (let y = 0; y < matrix.length; y++) {
                for (let x = 0; x < matrix[y].length; x++) {
                    if (matrix[y][x]) {
                        drawBlock(nextCtx, x + offsetX, y + offsetY, nextPiece.colorId);
                    }
                }
            }
        }

        // 碰撞檢測
        function collide(board, player) {
            const [m, o] = [player.matrix, player.pos];
            for (let y = 0; y < m.length; y++) {
                for (let x = 0; x < m[y].length; x++) {
                    if (m[y][x] !== 0 &&
                       (board[y + o.y] &&
                        board[y + o.y][x + o.x]) !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        // 合併玩家方塊到遊戲板
        function merge(board, player) {
            player.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        board[y + player.pos.y][x + player.pos.x] = value;
                    }
                });
            });
        }

        // 旋轉方塊
        function rotate(matrix, dir) {
            const result = matrix.map((_, index) =>
                matrix.map(col => col[index])
            );
            
            if (dir > 0) {
                return result.map(row => row.reverse());
            } else {
                return result.reverse();
            }
        }

        // 玩家旋轉
        function playerRotate(dir) {
            if (gameOver || paused) return;
            
            const pos = player.pos.x;
            let offset = 1;
            const rotated = rotate(player.matrix, dir);
            
            player.matrix = rotated;
            
            // 解決旋轉後可能出現的碰撞
            while (collide(board, player)) {
                player.pos.x += offset;
                offset = -(offset + (offset > 0 ? 1 : -1));
                if (offset > player.matrix[0].length) {
                    player.matrix = rotate(player.matrix, -dir);
                    player.pos.x = pos;
                    return;
                }
            }
            
            // 播放旋轉音效
            gameAudio.playRotate();
            drawBoard();
        }

        // 玩家移動
        function playerMove(dir) {
            if (gameOver || paused) return;
            
            player.pos.x += dir;
            if (collide(board, player)) {
                player.pos.x -= dir;
                return false;
            }
            // 播放移動音效
            gameAudio.playMove();
            drawBoard();
            return true;
        }

        // 玩家下落
        function playerDrop() {
            if (gameOver || paused) return;
            
            player.pos.y++;
            if (collide(board, player)) {
                player.pos.y--;
                merge(board, player);
                
                // 方塊放置特效
                particleSystem.createBlockPlaceEffect(player.pos.x, player.pos.y);
                
                playerReset();
                sweep();
                updateScore();
            }
            dropCounter = 0;
            drawBoard();
        }

        // 玩家硬降（直接落到底部）
        function playerHardDrop() {
            if (gameOver || paused) return;
            
            while (!collide(board, player)) {
                player.pos.y++;
            }
            player.pos.y--;
            // 播放硬降音效
            gameAudio.playDrop();
            playerDrop();
        }

        // 重置玩家方塊
        function playerReset() {
            player.matrix = nextPiece.matrix;
            player.pos.y = 0;
            player.pos.x = Math.floor(COLS / 2) - Math.floor(player.matrix[0].length / 2);
            
            // 生成新的下一個方塊
            nextPiece = createPiece();
            drawNextPiece();
            
            // 檢查遊戲是否結束
            if (collide(board, player)) {
                gameOver = true;
                document.getElementById('game-status').textContent = '遊戲結束!';
                document.getElementById('game-status').style.color = '#ff003c';
                // 遊戲結束時停止特效
                stopSpecialEffect();
                // 播放遊戲結束音效
                gameAudio.playGameOver();
            }
        }

        // 清除完整的行並計分
        function sweep() {
            let rowCount = 0;
            
            outer: for (let y = board.length - 1; y >= 0; y--) {
                for (let x = 0; x < board[y].length; x++) {
                    if (board[y][x] === 0) {
                        continue outer;
                    }
                }
                
                // 移除完整的行並在頂部添加新行
                const row = board.splice(y, 1)[0].fill(0);
                board.unshift(row);
                rowCount++;
                y++;
            }
            
            if (rowCount > 0) {
                // 根據消除行數計算得分
                let pointsEarned = 0;
                
                if (rowCount === 4) {
                    // 全版圖消除：30分
                    pointsEarned = 30;
                    fullClears++;
                    
                    // 觸發全版圖消除特效
                    triggerSpecialEffect();
                    
                    // 顯示特效通知
                    showEffectNotification("全版圖消除!");
                    
                    // 播放特殊效果音效
                    gameAudio.playSpecialEffect();
                    
                    // 創建特殊粒子效果
                    for (let i = 0; i < 4; i++) {
                        particleSystem.createClearLineEffect(i, rowCount);
                    }
                } else {
                    // 普通消除：10分每行
                    pointsEarned = rowCount * 10;
                }
                
                // 播放消除音效
                gameAudio.playClear(rowCount);
                
                // 創建消除粒子效果
                if (rowCount < 4) {
                    particleSystem.createClearLineEffect(0, rowCount);
                }
                
                // 創建得分彈出效果
                particleSystem.createScorePopup(pointsEarned, COLS / 2, ROWS / 2);
                
                // 更新分數
                lines += rowCount;
                score += pointsEarned;
                
                // 每消除10行升一級
                const newLevel = Math.floor(lines / 10) + 1;
                if (newLevel > level) {
                    level = newLevel;
                    // 播放升級音效
                    gameAudio.playLevelUp();
                    // 升級特效
                    particleSystem.createLevelUpEffect();
                }
                
                // 更新下落速度（隨等級提高而加快）
                dropInterval = Math.max(100, 1000 - (level - 1) * 50);
                
                // 顯示得分動畫
                showScoreAnimation(pointsEarned);
                
                // 檢查成就
                achievementSystem.checkAchievements();
                
                // 追蹤完美清除
                if (rowCount === 4) {
                    achievementSystem.trackPerfectClear();
                }
            }
        }
        
        // 顯示得分動畫
        function showScoreAnimation(points) {
            const scoreElement = document.getElementById('score');
            scoreElement.classList.remove('score-animation');
            void scoreElement.offsetWidth; // 觸發重排以重置動畫
            scoreElement.classList.add('score-animation');
            
            // 如果是全版圖消除，也為全版圖計數器添加動畫
            if (points === 30) {
                const fullClearsElement = document.getElementById('full-clears');
                fullClearsElement.classList.remove('score-animation');
                void fullClearsElement.offsetWidth;
                fullClearsElement.classList.add('score-animation');
            }
        }
        
        // 顯示特效通知
        function showEffectNotification(text) {
            if (effectNotificationActive) return;
            
            effectNotificationActive = true;
            const notification = document.createElement('div');
            notification.className = 'effect-notification';
            notification.textContent = text;
            document.querySelector('.game-board').appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
                effectNotificationActive = false;
            }, 2000);
        }

        // 更新分數顯示
        function updateScore() {
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('lines').textContent = lines;
            document.getElementById('full-clears').textContent = fullClears;
            
            // 更新最高分
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('tetrisHighScore', highScore);
                document.getElementById('high-score').textContent = highScore;
                document.getElementById('high-score').classList.add('score-animation');
                setTimeout(() => {
                    document.getElementById('high-score').classList.remove('score-animation');
                }, 1000);
            } else {
                document.getElementById('high-score').textContent = highScore;
            }
        }
        
        // 觸發全版圖消除特效
        function triggerSpecialEffect() {
            isSpecialEffectActive = true;
            specialEffectTimer = SPECIAL_EFFECT_DURATION;
            
            // 顯示特效層
            const effectLayer = document.getElementById('special-effect');
            effectLayer.style.opacity = '1';
            
            // 更新面板背景色
            document.querySelector('.left-panel').style.backgroundColor = 'rgba(10, 10, 20, 0.9)';
            document.querySelector('.right-panel').style.backgroundColor = 'rgba(10, 10, 20, 0.9)';
            
            // 更新遊戲狀態顯示
            document.getElementById('game-status').textContent = '全版圖消除特效!';
            document.getElementById('game-status').style.color = '#ff0080';
        }
        
        // 停止特效
        function stopSpecialEffect() {
            isSpecialEffectActive = false;
            specialEffectTimer = 0;
            
            // 隱藏特效層
            const effectLayer = document.getElementById('special-effect');
            effectLayer.style.opacity = '0';
            
            // 恢復面板背景色
            document.querySelector('.left-panel').style.backgroundColor = 'rgba(20, 20, 30, 0.8)';
            document.querySelector('.right-panel').style.backgroundColor = 'rgba(20, 20, 30, 0.8)';
            
            // 如果不是遊戲結束狀態，恢復遊戲狀態顯示
            if (!gameOver) {
                document.getElementById('game-status').textContent = '遊戲進行中...';
                document.getElementById('game-status').style.color = '#00ff87';
            }
        }
        
        // 更新特效
        function updateSpecialEffect(deltaTime) {
            if (!isSpecialEffectActive) return;
            
            specialEffectTimer -= deltaTime;
            
            // 更新顏色偏移
            colorOffset = (colorOffset + deltaTime * 0.1) % 360;
            
            // 如果特效時間結束，停止特效
            if (specialEffectTimer <= 0) {
                stopSpecialEffect();
            }
        }

        // 遊戲主循環
        function update(time = 0) {
            const deltaTime = time - lastTime;
            lastTime = time;
            
            // 記錄幀率用於性能監控
            performanceOptimizer.recordFrame(time);
            
            if (!paused && !gameOver) {
                dropCounter += deltaTime;
                if (dropCounter > dropInterval) {
                    playerDrop();
                }
                
                // 更新特效
                updateSpecialEffect(deltaTime);
                
                // 檢查遊戲時間成就（每10秒檢查一次）
                if (gameStartTime > 0 && (time - gameStartTime) % 10000 < deltaTime) {
                    const gameSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
                    achievementSystem.trackGameTime(gameSeconds);
                }
                
                drawBoard();
                drawNextPiece();
            }
            
            requestAnimationFrame(update);
        }

        // 鍵盤控制
        document.addEventListener('keydown', event => {
            if (gameOver) return;
            
            switch (event.keyCode) {
                case 37: // 左箭頭
                    playerMove(-1);
                    break;
                case 39: // 右箭頭
                    playerMove(1);
                    break;
                case 40: // 下箭頭
                    playerDrop();
                    break;
                case 38: // 上箭頭
                    playerRotate(1);
                    break;
                case 32: // 空格鍵
                    playerHardDrop();
                    break;
                case 80: // P鍵
                    togglePause();
                    break;
                case 82: // R鍵
                    init();
                    break;
            }
        });

        // 遊戲控制按鈕事件
        document.getElementById('start-btn').addEventListener('click', () => {
            if (gameOver) {
                init();
            }
            
            if (paused) {
                togglePause();
            }
            
            document.getElementById('game-status').textContent = '遊戲進行中...';
            document.getElementById('game-status').style.color = '#00ff87';
        });
        
        document.getElementById('pause-btn').addEventListener('click', togglePause);
        
        document.getElementById('reset-btn').addEventListener('click', init);
        
        // 暫停/繼續遊戲
        function togglePause() {
            if (gameOver) return;
            
            paused = !paused;
            
            if (paused) {
                document.getElementById('game-status').textContent = '遊戲暫停';
                document.getElementById('game-status').style.color = '#ff9900';
                document.getElementById('pause-btn').textContent = '繼續遊戲';
            } else {
                document.getElementById('game-status').textContent = '遊戲進行中...';
                document.getElementById('game-status').style.color = '#00ff87';
                document.getElementById('pause-btn').textContent = '暫停遊戲';
            }
        }
        
        // 防止遊戲區域內的觸摸滾動
        function preventTouchScroll(e) {
            if (e.target.closest('.game-board') || e.target.closest('.left-panel') || e.target.closest('.right-panel')) {
                e.preventDefault();
            }
        }
        
        // 添加觸摸事件監聽器防止滾動
        document.addEventListener('touchmove', preventTouchScroll, { passive: false });
        document.addEventListener('wheel', preventTouchScroll, { passive: false });

        // 確保DOM完全加載後再初始化遊戲
        function safeInit() {
            try {
                console.log('開始初始化俄羅斯方塊...');
                
                // 檢查關鍵DOM元素
                const canvas = document.getElementById('game-canvas');
                if (!canvas) {
                    console.error('找不到遊戲畫布');
                    showError('遊戲初始化失敗：找不到畫布元素');
                    return;
                }
                
                // 檢查Canvas上下文
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('無法創建Canvas 2D上下文');
                    showError('遊戲初始化失敗：瀏覽器不支持Canvas');
                    return;
                }
                
                // 初始化遊戲
                init();
                
                // 開始遊戲循環
                update();
                
                console.log('俄羅斯方塊初始化完成');
                
            } catch (error) {
                console.error('俄羅斯方塊初始化失敗:', error);
                showError('遊戲初始化失敗: ' + error.message);
            }
        }
        
        // 錯誤顯示函數
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ff4757;
                color: white;
                padding: 20px;
                border-radius: 10px;
                font-family: Arial, sans-serif;
                z-index: 9999;
                text-align: center;
            `;
            errorDiv.innerHTML = `
                <h3>⚠️ 錯誤</h3>
                <p>${message}</p>
                <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 15px; background: white; color: #ff4757; border: none; border-radius: 5px; cursor: pointer;">重新載入</button>
            `;
            document.body.appendChild(errorDiv);
        }
        
        // 等待DOM加載完成
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInit);
        } else {
            safeInit();
        }
    </script>
    
    <!-- 移動端虛擬控制器 -->
    <div class="mobile-controller" id="mobile-controller">
        <div class="dpad-container">
            <div class="dpad">
                <button class="dpad-btn up" data-action="rotate">⟲</button>
                <button class="dpad-btn down" data-action="down">↓</button>
                <button class="dpad-btn left" data-action="left">←</button>
                <button class="dpad-btn right" data-action="right">→</button>
                <button class="dpad-btn center" data-action="rotate">⟲</button>
            </div>
        </div>
        <div class="action-buttons">
            <button class="action-btn drop" data-action="harddrop">⬇</button>
            <button class="action-btn pause" data-action="pause">⏸</button>
        </div>
    </div>
    
    <!-- 教程覆蓋層 -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-content">
            <h2 class="tutorial-title" id="tutorial-title">歡迎來到俄羅斯方塊！</h2>
            <p class="tutorial-description" id="tutorial-description">讓我們一起學習如何遊玩這個經典遊戲</p>
            <div class="tutorial-progress" id="tutorial-progress"></div>
            <div class="tutorial-navigation">
                <button class="tutorial-btn skip" id="tutorial-skip">跳過教程</button>
                <button class="tutorial-btn" id="tutorial-next">下一步</button>
            </div>
        </div>
    </div>
    
    <!-- 粒子特效容器 -->
    <div class="particle-container" id="particle-container"></div>
    
    <!-- 成就通知 -->
    <div class="achievement-notification" id="achievement-notification">
        <div class="achievement-header">
            <div class="achievement-icon">🏆</div>
            <div class="achievement-title" id="achievement-title">成就解鎖！</div>
        </div>
        <div class="achievement-description" id="achievement-description">描述</div>
        <div class="achievement-points" id="achievement-points">+0 經驗值</div>
    </div>
    
    <!-- 成就面板 -->
    <div class="achievements-panel" id="achievements-panel">
        <div class="achievements-content">
            <div class="achievements-header">
                <div class="achievements-title">🏆 成就系統</div>
                <button class="achievements-close" id="achievements-close">✕</button>
            </div>
            <div class="achievements-grid" id="achievements-grid">
                <!-- 成就卡片將由JavaScript動態生成 -->
            </div>
        </div>
    </div>
    
    <!-- 性能監控面板（開發模式） -->
    <div class="performance-monitor" id="performance-monitor">
        <div>FPS: <span id="fps-display">0</span></div>
        <div>平均FPS: <span id="avg-fps-display">0</span></div>
        <div>質量級別: <span id="quality-display">high</span></div>
        <div>粒子數: <span id="particle-count">0</span></div>
        <div>設備類型: <span id="device-type">desktop</span></div>
    </div>
</body>
</html>
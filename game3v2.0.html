<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«”æ„Ÿæ˜Ÿæ˜Ÿå¤§å†’éšª - æ‰‹æŒæ§åˆ¶ç‰ˆ</title>
    <!-- å¼•å…¥ MediaPipe Hands èˆ‡ Camera Utils -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --primary-color: #00d2ff;
            --accent-color: #ffd700;
            --danger-color: #ff4757;
            --bg-color: #1e272e;
            --ui-bg: rgba(0, 0, 0, 0.85);
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        /* éŠæˆ²å®¹å™¨ */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 1280px;
            max-height: 720px;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border-radius: 8px;
        }

        /* æ”å½±æ©Ÿèˆ‡ç•«å¸ƒ */
        .camera-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ï¼Œè®“æ“ä½œæ›´ç›´è¦º */
            opacity: 0.3; /* è®“èƒŒæ™¯æš—ä¸€é»ï¼Œçªå‡ºéŠæˆ²å…ƒç´  */
            z-index: 1;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* UI å±¤ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* HUD (åˆ†æ•¸æ¿) */
        #hud {
            display: flex;
            justify-content: space-between;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .score-box span {
            color: var(--accent-color);
        }

        /* è¼‰å…¥èˆ‡é¸å–®è¦†è“‹å±¤ */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--ui-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            transition: opacity 0.3s;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        h1 {
            font-size: 48px;
            margin-bottom: 10px;
            color: var(--primary-color);
            text-shadow: 0 0 20px var(--primary-color);
            text-align: center;
        }

        p {
            font-size: 18px;
            color: #ddd;
            margin-bottom: 30px;
            max-width: 600px;
            text-align: center;
            line-height: 1.6;
        }

        .btn {
            background: linear-gradient(45deg, var(--primary-color), #007bff);
            border: none;
            padding: 15px 40px;
            color: white;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 210, 255, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 210, 255, 0.6);
        }

        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ç‹€æ…‹æŒ‡ç¤ºå™¨ */
        #status-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ccc;
        }

        .dot.loading { background-color: #f1c40f; animation: blink 1s infinite; }
        .dot.ready { background-color: #2ecc71; }
        .dot.error { background-color: #e74c3c; }

        @keyframes blink {
            50% { opacity: 0.4; }
        }

        /* æ‰‹å‹¢æ•™å­¸åœ–ç¤º */
        .tutorial-icons {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
        }
        .icon-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 14px;
            color: #aaa;
        }
        .icon-box {
            width: 60px;
            height: 60px;
            border: 2px solid #555;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
        }

    </style>
</head>
<body>

<div id="game-container">
    <!-- æ”å½±æ©Ÿå½±åƒ -->
    <video class="camera-view" id="input-video" playsinline></video>
    
    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="game-canvas"></canvas>

    <!-- UI ç‹€æ…‹å±¤ -->
    <div id="ui-layer">
        <div id="status-indicator">
            <div class="dot loading" id="status-dot"></div>
            <span id="status-text">æ­£åœ¨è¼‰å…¥ AI æ¨¡å‹...</span>
        </div>

        <div id="hud" class="hidden">
            <div>åˆ†æ•¸: <span id="score-display">0</span></div>
            <div>æœ€é«˜åˆ†: <span id="highscore-display">0</span></div>
        </div>
    </div>

    <!-- é–‹å§‹/è¼‰å…¥ç•«é¢ -->
    <div id="start-screen" class="overlay">
        <h1>é«”æ„Ÿæ˜Ÿæ˜Ÿå¤§å†’éšª</h1>
        <p>
            è«‹å…è¨±ä½¿ç”¨æ”å½±æ©Ÿã€‚éŠæˆ²ä¸­è«‹èˆ‰èµ·ä¸€éš»æ‰‹ï¼Œ<br>
            ä½¿ç”¨ <b>é£ŸæŒ‡æŒ‡å°–</b> æ§åˆ¶è—è‰²å…‰çƒç§»å‹•ã€‚
        </p>
        
        <div class="tutorial-icons">
            <div class="icon-item">
                <div class="icon-box" style="border-color: var(--primary-color);">ğŸ‘†</div>
                <span>é£ŸæŒ‡æ§åˆ¶</span>
            </div>
            <div class="icon-item">
                <div class="icon-box" style="border-color: var(--accent-color);">â­</div>
                <span>æ”¶é›†æ˜Ÿæ˜Ÿ</span>
            </div>
            <div class="icon-item">
                <div class="icon-box" style="border-color: var(--danger-color);">ğŸ”´</div>
                <span>é¿é–‹ç´…çƒ</span>
            </div>
        </div>

        <button id="start-btn" class="btn" disabled>è¼‰å…¥ä¸­...</button>
    </div>

    <!-- éŠæˆ²çµæŸç•«é¢ -->
    <div id="game-over-screen" class="overlay hidden">
        <h1 style="color: var(--danger-color)">éŠæˆ²çµæŸ</h1>
        <p>ä½ çš„å¾—åˆ†: <span id="final-score" style="color: white; font-size: 24px; font-weight: bold;">0</span></p>
        <button id="restart-btn" class="btn">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<script>
    // --- éŠæˆ²è¨­å®šèˆ‡è®Šæ•¸ ---
    const videoElement = document.getElementById('input-video');
    const canvasElement = document.getElementById('game-canvas');
    const canvasCtx = canvasElement.getContext('2d');
    
    // UI å…ƒç´ 
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const hud = document.getElementById('hud');
    const scoreDisplay = document.getElementById('score-display');
    const highScoreDisplay = document.getElementById('highscore-display');
    const finalScoreDisplay = document.getElementById('final-score');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');

    let isGameRunning = false;
    let score = 0;
    let highScore = localStorage.getItem('handGameHighScore') || 0;
    let lastTime = 0;

    // ç©å®¶è¨­å®š
    const player = {
        x: window.innerWidth / 2,
        y: window.innerHeight / 2,
        radius: 20,
        color: '#00d2ff',
        targetX: window.innerWidth / 2, // æ‰‹å‹¢ç›®æ¨™ä½ç½®
        targetY: window.innerHeight / 2
    };

    // éŠæˆ²ç‰©ä»¶é™£åˆ—
    let stars = [];
    let obstacles = [];
    
    // ç”Ÿæˆè¨ˆæ™‚å™¨
    let starTimer = 0;
    let obstacleTimer = 0;
    
    // é›£åº¦èª¿æ•´
    let obstacleSpeedMultiplier = 1;

    // --- MediaPipe åˆå§‹åŒ– ---
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
    });

    hands.onResults(onHandsResults);

    // è¨­å®šæ”å½±æ©Ÿ
    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 1280,
        height: 720
    });

    // å•Ÿå‹•æ”å½±æ©Ÿ
    camera.start()
        .then(() => {
            console.log("æ”å½±æ©Ÿå·²å•Ÿå‹•");
        })
        .catch(err => {
            console.error("æ”å½±æ©ŸéŒ¯èª¤:", err);
            statusDot.className = 'dot error';
            statusText.innerText = "ç„¡æ³•å•Ÿå‹•æ”å½±æ©Ÿ";
        });

    // ç•¶æ¨¡å‹æº–å‚™å¥½æ™‚ (MediaPipe æ²’æœ‰ç›´æ¥çš„ 'ready' äº‹ä»¶ï¼Œæˆ‘å€‘ç”¨ onResults ç¬¬ä¸€æ¬¡è§¸ç™¼åˆ¤æ–·)
    let isModelLoaded = false;

    // --- éŠæˆ²é‚è¼¯ ---

    function onHandsResults(results) {
        if (!isModelLoaded) {
            isModelLoaded = true;
            statusDot.className = 'dot ready';
            statusText.innerText = "ç³»çµ±æº–å‚™å°±ç·’";
            startBtn.disabled = false;
            startBtn.innerText = "é–‹å§‹éŠæˆ²";
        }

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // å–å¾—é£ŸæŒ‡æŒ‡å°– (Index Finger Tip - ID: 8)
            const indexFingerTip = landmarks[8];
            
            // æ³¨æ„ï¼šMediaPipe çš„ x åæ¨™æ˜¯ 0 (å·¦) åˆ° 1 (å³)ã€‚
            // å› ç‚ºæˆ‘å€‘åœ¨ CSS æŠŠå½±ç‰‡ç¿»è½‰äº† (scaleX(-1))ï¼Œè¦–è¦ºä¸Šå³é‚Šæ˜¯ x=0ã€‚
            // ç‚ºäº†è®“æ‰‹å¾€å³ç§»æ™‚ï¼ŒéŠæˆ²è§’è‰²ä¹Ÿå¾€å³ç§»ï¼Œæˆ‘å€‘éœ€è¦å° x åšé¡åƒè™•ç†ã€‚
            // åŸå§‹å½±åƒ x: 0->1. é¡åƒå¾Œ: 1->0.
            
            player.targetX = (1 - indexFingerTip.x) * canvasElement.width;
            player.targetY = indexFingerTip.y * canvasElement.height;
        }
    }

    // å¹³æ»‘ç§»å‹•
    function lerp(start, end, factor) {
        return start + (end - start) * factor;
    }

    function resizeCanvas() {
        const container = document.getElementById('game-container');
        canvasElement.width = container.clientWidth;
        canvasElement.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    highScoreDisplay.innerText = highScore;

    // éŠæˆ²è¿´åœˆ
    function gameLoop(timestamp) {
        if (!isGameRunning) return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        // æ¸…é™¤ç•«å¸ƒ
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // æ›´æ–°ç©å®¶ä½ç½® (Lerp å¹³æ»‘è™•ç†)
        player.x = lerp(player.x, player.targetX, 0.2);
        player.y = lerp(player.y, player.targetY, 0.2);

        // ç¹ªè£½ç©å®¶
        canvasCtx.beginPath();
        canvasCtx.arc(player.x, player.y, player.radius, 0, 2 * Math.PI);
        canvasCtx.fillStyle = player.color;
        canvasCtx.shadowBlur = 20;
        canvasCtx.shadowColor = player.color;
        canvasCtx.fill();
        canvasCtx.shadowBlur = 0;
        canvasCtx.closePath();

        // ç¹ªè£½æ‰‹å‹¢è¿½è¹¤é» (å¯é¸ï¼Œè¦–è¦ºè¼”åŠ©)
        canvasCtx.beginPath();
        canvasCtx.arc(player.targetX, player.targetY, 5, 0, 2 * Math.PI);
        canvasCtx.fillStyle = "rgba(255, 255, 255, 0.5)";
        canvasCtx.fill();
        canvasCtx.closePath();

        // è™•ç†æ˜Ÿæ˜Ÿ
        starTimer += deltaTime;
        if (starTimer > 1000) { // æ¯ç§’å˜—è©¦ç”Ÿæˆæ˜Ÿæ˜Ÿ
            spawnStar();
            starTimer = 0;
        }

        for (let i = stars.length - 1; i >= 0; i--) {
            const s = stars[i];
            // ç¹ªè£½æ˜Ÿæ˜Ÿ (ç°¡åŒ–ç‚ºé‡‘è‰²åœ“å½¢)
            canvasCtx.beginPath();
            canvasCtx.arc(s.x, s.y, s.radius, 0, 2 * Math.PI);
            canvasCtx.fillStyle = '#ffd700';
            canvasCtx.fill();
            canvasCtx.strokeStyle = '#fff';
            canvasCtx.lineWidth = 2;
            canvasCtx.stroke();
            canvasCtx.closePath();

            // ç¢°æ’æª¢æ¸¬ (ç©å®¶ vs æ˜Ÿæ˜Ÿ)
            const dist = Math.hypot(player.x - s.x, player.y - s.y);
            if (dist < player.radius + s.radius) {
                // æ”¶é›†æˆåŠŸ
                score += 10;
                scoreDisplay.innerText = score;
                createParticles(s.x, s.y, '#ffd700');
                stars.splice(i, 1);
                
                // é›£åº¦éš¨åˆ†æ•¸æå‡
                if (score % 50 === 0) {
                    obstacleSpeedMultiplier += 0.1;
                }
            }
        }

        // è™•ç†éšœç¤™ç‰©
        obstacleTimer += deltaTime;
        // ç”Ÿæˆé »ç‡éš¨é›£åº¦ç•¥å¾®åŠ å¿«ï¼Œä½†æœ‰ä¸Šé™
        let spawnRate = Math.max(500, 1000 - (score * 2)); 
        if (obstacleTimer > spawnRate) {
            spawnObstacle();
            obstacleTimer = 0;
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            const obs = obstacles[i];
            obs.y += obs.speed * obstacleSpeedMultiplier;
            obs.rotation += 0.05;

            // ç¹ªè£½éšœç¤™ç‰© (ç´…è‰²å¸¶åˆºçƒé«”æ„Ÿ)
            canvasCtx.save();
            canvasCtx.translate(obs.x, obs.y);
            canvasCtx.rotate(obs.rotation);
            canvasCtx.beginPath();
            // ç•«ä¸€å€‹ç°¡å–®çš„å¤šé‚Šå½¢æ¨¡æ“¬åˆº
            const spikes = 8;
            const outerRadius = obs.radius;
            const innerRadius = obs.radius / 2;
            for(let j=0; j<spikes*2; j++){
                const r = (j%2 === 0) ? outerRadius : innerRadius;
                const currAngle = (Math.PI / spikes) * j;
                const x = Math.cos(currAngle) * r;
                const y = Math.sin(currAngle) * r;
                if(j===0) canvasCtx.moveTo(x, y);
                else canvasCtx.lineTo(x, y);
            }
            canvasCtx.closePath();
            canvasCtx.fillStyle = '#ff4757';
            canvasCtx.fill();
            canvasCtx.restore();

            // ç§»é™¤è¶…å‡ºç•«é¢çš„éšœç¤™ç‰©
            if (obs.y > canvasElement.height + obs.radius) {
                obstacles.splice(i, 1);
                continue;
            }

            // ç¢°æ’æª¢æ¸¬ (ç©å®¶ vs éšœç¤™ç‰©)
            // ç‚ºäº†å…¬å¹³ä¸€é»ï¼Œéšœç¤™ç‰©ç¢°æ’åˆ¤å®šç¨å¾®æ¯”è¦–è¦ºå°ä¸€é»
            const dist = Math.hypot(player.x - obs.x, player.y - obs.y);
            if (dist < (player.radius + obs.radius * 0.8)) {
                gameOver();
                return;
            }
        }

        // ç²’å­æ•ˆæœæ›´æ–°
        updateAndDrawParticles();

        requestAnimationFrame(gameLoop);
    }

    // --- ç”Ÿæˆå™¨ ---

    function spawnStar() {
        if (stars.length > 3) return; // é™åˆ¶åŒæ™‚å­˜åœ¨çš„æ•¸é‡
        stars.push({
            x: Math.random() * (canvasElement.width - 40) + 20,
            y: Math.random() * (canvasElement.height - 40) + 20,
            radius: 15
        });
    }

    function spawnObstacle() {
        const radius = Math.random() * 15 + 15; // 15~30
        obstacles.push({
            x: Math.random() * canvasElement.width,
            y: -radius,
            radius: radius,
            speed: Math.random() * 3 + 2, // åŸºç¤é€Ÿåº¦
            rotation: 0
        });
    }

    // --- ç²’å­ç³»çµ± (è¦–è¦ºæ•ˆæœ) ---
    let particles = [];
    function createParticles(x, y, color) {
        for (let i = 0; i < 8; i++) {
            particles.push({
                x: x,
                y: y,
                vx: (Math.random() - 0.5) * 5,
                vy: (Math.random() - 0.5) * 5,
                life: 1.0,
                color: color
            });
        }
    }

    function updateAndDrawParticles() {
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.life -= 0.05;
            
            if (p.life <= 0) {
                particles.splice(i, 1);
            } else {
                canvasCtx.globalAlpha = p.life;
                canvasCtx.fillStyle = p.color;
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, 3, 0, Math.PI*2);
                canvasCtx.fill();
                canvasCtx.globalAlpha = 1.0;
            }
        }
    }

    // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

    function startGame() {
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        hud.classList.remove('hidden');
        
        isGameRunning = true;
        score = 0;
        obstacleSpeedMultiplier = 1;
        scoreDisplay.innerText = score;
        
        stars = [];
        obstacles = [];
        particles = [];

        // åˆå§‹ç”Ÿæˆä¸€å€‹æ˜Ÿæ˜Ÿ
        spawnStar();

        lastTime = performance.now();
        requestAnimationFrame(gameLoop);
    }

    function gameOver() {
        isGameRunning = false;
        finalScoreDisplay.innerText = score;
        
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('handGameHighScore', highScore);
            highScoreDisplay.innerText = highScore;
        }

        gameOverScreen.classList.remove('hidden');
        hud.classList.add('hidden');
    }

    // --- äº‹ä»¶ç›£è½ ---
    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', startGame);

</script>
</body>
</html>